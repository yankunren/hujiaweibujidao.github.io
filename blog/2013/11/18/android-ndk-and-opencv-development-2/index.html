
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>android ndk and opencv development 2 - Hujiawei Bujidao</title>
  <meta name="author" content="hujiawei">

  
  <meta name="description" content="Android NDK 和 OpenCV 整合开发总结(2) 这节主要介绍的内容是Android NDK的核心内容和开发总结(包括很多常见问题的解决方案)，本节分为三部分：
* JNI技术和javah命令
* Android NDK Dev Guide
* NDK开发中常见的问题 1. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hujiaweibujidao.github.io/blog/2013/11/18/android-ndk-and-opencv-development-2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Hujiawei Bujidao" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
	<header role="banner">
		<hgroup>
	<h1><a href="/"><img src="/images/dolphin-small.png"  />Hujiawei Bujidao</a></h1>
	
	<h2>Love coding, travelling, family and MY QUEEN.</h2>
	
</hgroup>


	</header>
	<nav role="navigation">
		<ul class="subscription" data-subscription="rss">

  <!-- <li><a href="https://github.com/hujiaweibujidao" rel="subscribe-rss" title="subscribe via RSS">View me on GitHub</a></li> -->
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
   
</ul>

  <!--
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hujiaweibujidao.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form> 
  
  -->
<ul class="main-navigation">
  <li><a href="/blog/archives/">Blog</a></li>
  <li><a href="/aboutme/">AboutMe</a></li>
  <li><a href="/math/">Math</a></li>
  <li><a href="/datamining/">DataMining</a></li>
  <li><a href="/blog/categories/mobiledev/">MobileDev</a></li>
  <!-- <li><a href="/datamining/">Projects</a></li> -->
  <!--
  <li><a href="/blog/archives">Archives</a></li>
  -->
</ul>


	</nav>
	<div id="main">
		<div id="content">
			<div>
	<article class="hentry" role="article">
		
  <header>
    
      <h1 class="entry-title">Android Ndk and Opencv Development 2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-18T15:59:00+08:00" pubdate data-updated="true">Nov 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Android NDK 和 OpenCV 整合开发总结(2)</h3>

<p>这节主要介绍的内容是<a href="http://developer.android.com/tools/sdk/ndk/index.html">Android NDK</a>的核心内容和开发总结(包括很多常见问题的解决方案)，本节分为三部分：<br/>
* JNI技术和javah命令
* Android NDK Dev Guide
* NDK开发中常见的问题</p>

<h4>1.不得不说的JNI和javah命令</h4>

<p>NDK开发的核心之一便是JNI，<a href="http://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/jniTOC.html">Oracle官方的JNI相关文档</a>，重要的是里面的第3-4部分(数据类型和函数)，本文不会介绍这些，如果想快速入手可以查看<a href="http://my.oschina.net/zhiweiofli/blog?catalog=225458">这位作者的几篇关于JNI的文章</a>，讲得深入浅出，另外推荐一篇<a href="http://www.ibm.com/developerworks/cn/java/j-lo-jni/index.html">IBM DeveloperWorks上的文章:JNI 对象在函数调用中的生命周期</a>，讲得有点深奥哟。</p>

<ul>
<li><p><a href="http://docs.oracle.com/javase/6/docs/technotes/tools/windows/javah.html">javah命令：详细命令参数</a>：<code>javah produces C header files and C source files from a Java class. These files provide the connective glue that allow your Java and C code to interact.</code></p></li>
<li><p>在Eclipse中配置<strong>万能的javah工具</strong>的方法</p></li>
</ul>


<p>(1)在<code>External Tools Configurations</code>中新建<code>Program</code></p>

<p>(2)<code>Location</code>设置为<code>/usr/bin/javah</code></p>

<p>(3)<code>Working Directory</code>设置为<code>${project_loc}/bin/classes</code></p>

<p>(4)<code>Arguments</code>设置为<code>-jni -verbose -d "${project_loc}${system_property:file.separator}jni" ${java_type_name}</code></p>

<p>(5)OK，以后只要选中要进行&#8221;反编译&#8221;的Java Class，然后运行这个External Tool就可以了！注意，因为我的<code>Arguments</code>设置为导出的头文件是放在项目的jni目录中，如果不是Android NDK开发的话，请自行修改输出路径，还有<code>Working Directory</code>设置为<code>${project_loc}/bin</code>，不要包含后面的<code>/classes</code>。如果还有问题的话，推荐看下<a href="http://blog.csdn.net/mirkerson/article/details/8901270">这位作者的JNI相关配置</a></p>

<h4>2.那些年的Android NDK Dev Guide</h4>

<p>在ndk的根目录下有一个html文件<code>document.html</code>，这个就是Android NDK Dev Guide，用浏览器打开可以看到里面介绍了NDK开发中的很多配置问题，不同版本的NDK差别还是蛮大的，而且NDK开发中问题会很多，不向SDK那么简单，所以，一旦出现了问题，运气好能够Google解决，RP弱的时候只能啃这些Guide来找答案了。这几篇文章的简单介绍可以查看<a href="http://developer.android.com/tools/sdk/ndk/index.html#Docs">Android Developer上的解释</a>。对于这部分的内容，可以阅读下<a href="http://blog.csdn.net/smfwuxiao/article/category/1328624">这位作者的几篇NDK Dev Guide的翻译版本</a>，虽然略有过时，但是看后肯定会很受用的，下面我简单介绍下几个内容：</p>

<ul>
<li>[1]Android NDK Overview</li>
</ul>


<p>这篇文章介绍了NDK的目标和NDK开发的简易实践过程，后面的那些文章基本上都是围绕这个核心内容展开的，非常建议阅读。需要注意的是，NDK只支持Android 1.5版本以上的机型。</p>

<ul>
<li>[2]Android.mk文件</li>
</ul>


<p>Android.mk文件是用来描述源代码是如何进行编译的，ndk-build命令实际上对GNU Make命令的一个封装，所以，Android.mk文件的写法就类似Makefile的写法[关于Make的详细内容可以看这本书，<a href="http://pan.baidu.com/s/1swSO7">GNU Make的中文手册</a>，虽然是今年读的，但是我记得的东西也不多了…]
Android.mk文件可以生成一个动态链接库或者一个静态链接库，但是只有动态链接库是会复制到应用的安装包中的，静态库一般是用来生成其他的动态链接库的。你可以在一个Android.mk文件定义一个或者多个module，不同的module可以使用相同的source file进行编译得到。你不需要列出头文件，也不需要显示指明要生成的目标文件之间的依赖关系(这些内容在GNU Make中是很重要的，虽然GNU Make中的隐式规则也可以做到)。下面以hello-jni项目中的Android.mk文件为例讲解其中重要的几点。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>LOCAL_PATH := $(call my-dir)
</span><span class='line'>include $(CLEAR_VARS)
</span><span class='line'>LOCAL_MODULE    := hello-jni
</span><span class='line'>LOCAL_SRC_FILES := hello-jni.c
</span><span class='line'>include $(BUILD_SHARED_LIBRARY)</span></code></pre></td></tr></table></div></figure>


<p>①<code>LOCAL_PATH := $(call my-dir)</code>：Android.mk文件的第一行必须要指明<code>LOCAL_PATH</code>，<code>my-dir</code>是编译系统提供的一个宏函数，这个宏函数会返回当前Android.mk文件所在的目录</p>

<p>②<code>include $(CLEAR_VARS)</code>：<code>CLEAR_VARS</code>是编译系统提供的一个变量，这个变量指向一个特殊的Makefile文件，它会清除所有除了<code>LOCAL_PATH</code>之外的其他的<code>LOCAL_XXX</code>变量。</p>

<p>③<code>LOCAL_MODULE := hello-jni</code>：必须要指定<code>LOCAL_MODULE</code>，它是指这个Android.mk要生成的目标，这个名称是一个<strong>不包含空格的唯一的字符串</strong>，编译系统会自动根据名称进行一定的修改，例如<code>foo.so</code>和<code>libfoo.so</code>得到的都是<code>libfoo.so</code>！</p>

<p>④<code>LOCAL_SRC_FILES := hello-jni.c</code>：指定C/C++源文件列表，不要包含头文件。如果需要自定义C++源文件的后缀，可以配置<code>LOCAL_CPP_EXTENSION</code>参数。注意写法，我给个例子，一定要记住每行后面加上一个反斜线符，并且反斜线符后面不能再有任何内容，否则编译会报错！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>LOCAL_SRC_FILES := hello-jni.c \
</span><span class='line'>foo.c  \
</span><span class='line'>boo.cpp</span></code></pre></td></tr></table></div></figure>


<p>⑤<code>include $(BUILD_SHARED_LIBRARY)</code>：<code>BUILD_SHARED_LIBRARY</code>是编译系统提供的一个Makefile文件，它会根据你前面提供的参数来生成动态链接库，同理，如果是<code>BUILD_STATIC_LIBRARY</code>的话，便是生成静态链接库。</p>

<p><strong>最佳实践</strong>：一般来说，<code>LOCAL_</code>作为前缀的一般定义LOCAL Module的变量，<code>PRIVATE_</code>或者<code>NDK_</code>或者<code>APP_</code>一般定义内部使用的变量，<code>lower-case</code>小写字母的名称一般也是定义内部使用的变量或者函数。如果你要在Android.mk文件定义自己的变量，建议使用<code>MY_</code>作为前缀！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MY_SOURCES := foo.c
</span><span class='line'>ifneq ($(MY_CONFIG_BAR),)
</span><span class='line'>   MY_SOURCES += bar.c
</span><span class='line'>endif
</span><span class='line'>LOCAL_SRC_FILES += $(MY_SOURCES)</span></code></pre></td></tr></table></div></figure>


<p>Android.mk这篇文章中后面详细介绍了很多编译系统内置的变量和函数，以及该文件内可以设置的变量，此处就不再赘述了。</p>

<ul>
<li>[3]Application.mk文件</li>
</ul>


<p>Application.mk文件描述的是你的应用需要使用哪些native modules，这个文件不是必须的，小项目可以不用编写这个文件。这个文件可以放在两个不同的位置，最常用的是放在jni目录下，和Android.mk文件放在一块，也可以放在<code>$NDK/apps/&lt;myapp&gt;/</code>目录下(不推荐使用后者，如果使用的是后者，那么必须要显示指定<code>APP_PROJECT_PATH</code>)</p>

<p>①<code>APP_MODULES</code>：这个参数在NDK r4之前是一定要指定的，之后便是可选的，默认情况下，NDK将编译Android.mk文件中定义的所有的modules。</p>

<p>②<code>APP_CFLAGS</code>：这个参数用来指定编译C/C++文件选项参数，例如<code>-frtti -fexceptions</code>等等，而<code>APP_CPPFLAGS</code>是专门用来指定C++源文件的选项参数。</p>

<p>③<code>APP_ABI</code>：这个参数很重要，默认情况下，NDK build将生成对应<code>armeabi</code>CPU架构的库文件，你可以指定其他的CPU架构，或者同时指定多个(自从NDK r7之后，设置为<code>all</code>可以生成所有CPU架构的库文件)！关于不同CPU架构的介绍在<code>CPU Arch ABIs</code>中介绍了，我不是很懂，此文不细讲。如果想要查看某个android设备是什么CPU架构，可以上网查，或者通过执行<code>adb shell getprop ro.product.cpu.abi</code>得到，下面这段摘自<a href="http://docs.opencv.org/doc/tutorials/introduction/android_binary_package/O4A_SDK.html">OpenCV for Android SDK</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>armeabi, armv7a-neon, arm7a-neon-android8, mips and x86 stand forplatform targets:
</span><span class='line'>   * armeabi is for ARM v5 and ARM v6 architectures with Android API 8+,
</span><span class='line'>   * armv7a-neon is for NEON-optimized ARM v7 with Android API 9+,
</span><span class='line'>   * arm7a-neon-android8 is for NEON-optimized ARM v7 with Android API 8,
</span><span class='line'>   * mips is for MIPS architecture with Android API 9+,
</span><span class='line'>   * x86 is for Intel x86 CPUs with Android API 9+.
</span><span class='line'>If using hardware device for testing/debugging, run the following command to learnits CPU architecture:
</span><span class='line'>*** adb shell getprop ro.product.cpu.abi ***
</span><span class='line'>If you’re using an AVD emulator, go Window &gt; AVD Manager to see thelist of availible devices. Click Edit in the context menu of theselected device. In the window, which then pop-ups, find the CPU field.</span></code></pre></td></tr></table></div></figure>


<p>④<code>APP_STL</code>：指定STL，默认情况下ndk编译系统使用最精简的C++运行时库<code>/system/lib/libstdc++.so</code>，但是你可以指定其他的。详细的内容可以查看<code>$NDK/docs/CPLUSPLUS-SUPPORT.html</code>文件，这个文件可能并没有列出在document.html中！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>system          -&gt; Use the default minimal system C++ runtime library.
</span><span class='line'>gabi++_static   -&gt; Use the GAbi++ runtime as a static library.
</span><span class='line'>gabi++_shared   -&gt; Use the GAbi++ runtime as a shared library.
</span><span class='line'>stlport_static  -&gt; Use the STLport runtime as a static library.
</span><span class='line'>stlport_shared  -&gt; Use the STLport runtime as a shared library.
</span><span class='line'>gnustl_static   -&gt; Use the GNU STL as a static library.
</span><span class='line'>gnustl_shared   -&gt; Use the GNU STL as a shared library.</span></code></pre></td></tr></table></div></figure>


<p>我们可以从下面的表格中看出它们对C++语言特性的支持程度：<br/>
从中我们可以看出gnustl很不错，所以一般会配置为gnustl_static。如果选用的是gnustl的话，一般还需要在<code>C/C++ General</code>下的<code>Paths and Symbols</code>中的<code>GNU C</code>和<code>GNU C++</code>配置里添加<code>${NDKROOT}/sources/cxx-stl/gnu-libstdc++/4.6/include</code> 和 <code>${NDKROOT}/sources/cxx-stl/gnu-libstdc++/4.6/libs/armeabi-v7a/include</code> 这两项。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>             C++       C++   Standard
</span><span class='line'>          Exceptions  RTTI    Library
</span><span class='line'>system        no       no        no
</span><span class='line'>gabi++       yes      yes        no
</span><span class='line'>stlport      yes      yes       yes
</span><span class='line'>gnustl       yes      yes       yes</span></code></pre></td></tr></table></div></figure>


<p>
另外需要注意的是，如果你指定的是<code>xxx_shared</code>，想要在运行时加载它，并且其他的库是基于<code>xxx_shared</code>的话，一定记得要先加载<code>xxx_shared</code>，然后再去加载其他的库。</p>

<p>⑤<code>APP_PLATFORM</code>：指定目标android系统版本，注意，指定的是<code>API level</code>，一般情况下，这里可能会与<code>AndroidManifest.xml</code>文件中定义的<code>minSdkVersion</code>冲突而报错，处理办法是类似上一节中提到的修改<code>APP_PLATFORM</code>保证两个不冲突就行了。</p>

<ul>
<li>[4]Stable-APIS</li>
</ul>


<p>build system会自动加载C库，Math库以及C++支持库，所以你不需要通过<code>LOCAL_LDLIBS</code>指定加载他们。Android系统下载有多个<code>API level</code>，每个<code>API level</code>都对应了一个Android的发布系统，对应关系如下所示。其中<code>android-6</code>，<code>android-7</code>和<code>android-5</code>是一样的NDK，也就是说他们提供的是相同的native ABIs。对应<code>API level</code>的头文件都放在了<code>$NDK/platforms/android-&lt;level&gt;/arch-arm/usr/include</code>目录下，这正是上一节中导入的项目中在<code>C/C++ General</code>下的<code>Paths and Symbols</code>中的<code>GNU C</code>和<code>GNU C++</code>配置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Note that the build system automatically links the C library, the Math
</span><span class='line'>library and the C++ support library to your native code, there is no
</span><span class='line'>need to list them in a LOCAL_LDLIBS line.
</span><span class='line'>There are several "API Levels" defined. Each API level corresponds to
</span><span class='line'>a given Android system platform release. The following levels are
</span><span class='line'>currently supported:
</span><span class='line'>    android-3      -&gt; Official Android 1.5 system images
</span><span class='line'>    android-4      -&gt; Official Android 1.6 system images
</span><span class='line'>    android-5      -&gt; Official Android 2.0 system images
</span><span class='line'>    android-6      -&gt; Official Android 2.0.1 system images
</span><span class='line'>    android-7      -&gt; Official Android 2.1 system images
</span><span class='line'>    android-8      -&gt; Official Android 2.2 system images
</span><span class='line'>    android-9      -&gt; Official Android 2.3 system images
</span><span class='line'>    android-14     -&gt; Official Android 4.0 system images
</span><span class='line'>Note that android-6 and android-7 are the same as android-5 for the NDK,
</span><span class='line'>i.e. they provide exactly the same native ABIs!
</span><span class='line'>IMPORTANT:
</span><span class='line'>    The headers corresponding to a given API level are now located
</span><span class='line'>    under $NDK/platforms/android-&lt;level&gt;/arch-arm/usr/include</span></code></pre></td></tr></table></div></figure>


<p> 介绍几个比较重要的库：<br/>
(1)C库(libc)：不需要指定 –lpthread –lrt，也就是说它会自动链接<br/>
(2)C++库(lstdc++)：不需要指定 –lstdc++<br/>
(3)Math库(libm)：不需要指定 –lm<br/>
(4)Android log(liblog)：<strong>需要</strong>指定 –llog <br/>
(5)动态链接器库(libdl)：不需要指定 –ldl<br/>
(6)Jnigraphics库(libjnigraphics)：这个C语言库提供了对Java中Bitmap的操作，<strong>需要</strong>指定 –ljnigraphics，这个库是<code>android-8</code>新增加的内容，典型的使用方式是：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Briefly, typical usage should look like:
</span><span class='line'>    1/ Use AndroidBitmap_getInfo() to retrieve information about a
</span><span class='line'>       given bitmap handle from JNI (e.g. its width/height/pixel format)
</span><span class='line'>    2/ Use AndroidBitmap_lockPixels() to lock the pixel buffer and
</span><span class='line'>       retrieve a pointer to it. This ensures the pixels will not move
</span><span class='line'>       until AndroidBitmap_unlockPixels() is called.
</span><span class='line'>    3/ Modify the pixel buffer, according to its pixel format, width,
</span><span class='line'>       stride, etc.., in native code.
</span><span class='line'>    4/ Call AndroidBitmap_unlockPixels() to unlock the buffer.</span></code></pre></td></tr></table></div></figure>


<p>(7)The Android native application APIs：<code>android-9</code>新增加的内容，这些API使得你可以完全使用native code编写android app，但是一般情况下还是需要通过jni的，相关API如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>The following headers correspond to these new native APIs (see comments
</span><span class='line'>inside them for more details):
</span><span class='line'>
</span><span class='line'>  &lt;android/native_activity.h&gt;
</span><span class='line'>
</span><span class='line'>        Activity lifecycle management (and general entry point)
</span><span class='line'>
</span><span class='line'>  &lt;android/looper.h&gt;
</span><span class='line'>  &lt;android/input.h&gt;
</span><span class='line'>  &lt;android/keycodes.h&gt;
</span><span class='line'>  &lt;android/sensor.h&gt;
</span><span class='line'>
</span><span class='line'>        To Listen to input events and sensors directly from native code.
</span><span class='line'>
</span><span class='line'>  &lt;android/rect.h&gt;
</span><span class='line'>  &lt;android/window.h&gt;
</span><span class='line'>  &lt;android/native_window.h&gt;
</span><span class='line'>  &lt;android/native_window_jni.h&gt;
</span><span class='line'>
</span><span class='line'>        Window management, including the ability to lock/unlock the pixel
</span><span class='line'>        buffer to draw directly into it.
</span><span class='line'>
</span><span class='line'>  &lt;android/configuration.h&gt;
</span><span class='line'>  &lt;android/asset_manager.h&gt;
</span><span class='line'>  &lt;android/storage_manager.h&gt;
</span><span class='line'>  &lt;android/obb.h&gt;
</span><span class='line'>        Direct (read-only) access to assets embedded in your .apk. or
</span><span class='line'>        the Opaque Binary Blob (OBB) files, a new feature of Android X.X
</span><span class='line'>        that allows one to distribute large amount of application data
</span><span class='line'>        outside of the .apk (useful for game assets, for example).
</span><span class='line'>
</span><span class='line'>All the corresponding functions are provided by the "libandroid.so" library
</span><span class='line'>version that comes with API level 9. To use it, use the following:
</span><span class='line'>
</span><span class='line'>    LOCAL_LDLIBS += -landroid</span></code></pre></td></tr></table></div></figure>


<ul>
<li>[5]NDK Build</li>
</ul>


<p>使用<code>ndk-build</code>命令(ndk r4之后引入的)实际上是GNU Make的封装，它等价于<code>make -f $NDK/build/core/build-local.mk [参数]</code>命令。系统必须要安装GNU Make 3.81以上版本，否则编译将报错！如果你安装了GNU Make 3.81，但是默认的make命令没有启动，那么可以在执行<code>ndk-build</code>之前定义GNUMAKE这个变量，例如<code>GNUMAKE=/usr/local/bin/gmake ndk-build</code>。<br/>
注意，在Windows下进行NDK开发的话，一般使用的是Cygwin自带的Make工具，但是默认是使用NDK的awk工具，所以可能会报一个错误<code>Android NDK: Host 'awk' tool is outdated. Please define HOST_AWK to point to Gawk or Nawk !</code>，解决方案就是删除NDK自带的awk工具<a href="http://blog.csdn.net/achellies/article/details/7531440">参考网址</a>，这也就是第一节中使用<code>ndk-build -v</code>命令得到的GNU Make信息输出不同了，嘿嘿，我这伏笔埋的够深吧！其实，也可以使用下面的方式直接覆盖系统的环境变量</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NDK_HOST_AWK=&lt;path-to-awk&gt;
</span><span class='line'>NDK_HOST_ECHO=&lt;path-to-echo&gt;
</span><span class='line'>NDK_HOST_CMP=&lt;path-to-cmp&gt;</span></code></pre></td></tr></table></div></figure>


<p>
如果还是不行的话，参见<a href="http://stackoverflow.com/questions/8384213/android-ndk-revision-7-host-awk-tool-is-outdated-error">StackOverflow上的解答</a><br/>
在Windows先开发还有一个需要注意的是，如果是使用Cygwin对native code进行编译，那么需要在使用<code>ndk-build</code>之前调用<code>NDK_USE_CYGPATH=1</code>！</p>

<p>下面是ndk-build命令的可用参数，比较常用的是 <code>ndk-build NDK_DEBUG=1</code> 或者 <code>ndk-build V=1</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  ndk-build                  --&gt; rebuild required machine code.
</span><span class='line'>  ndk-build clean            --&gt; clean all generated binaries.
</span><span class='line'>  ndk-build NDK_DEBUG=1      --&gt; generate debuggable native code.
</span><span class='line'>  ndk-build V=1              --&gt; launch build, displaying build commands.
</span><span class='line'>  ndk-build -B               --&gt; force a complete rebuild.
</span><span class='line'>  ndk-build -B V=1           --&gt; force a complete rebuild and display build
</span><span class='line'>                                 commands.
</span><span class='line'>  ndk-build NDK_LOG=1        --&gt; display internal NDK log messages
</span><span class='line'>                                 (used for debugging the NDK itself).
</span><span class='line'>  ndk-build NDK_DEBUG=1      --&gt; force a debuggable build (see below)
</span><span class='line'>  ndk-build NDK_DEBUG=0      --&gt; force a release build (see below)
</span><span class='line'>  ndk-build NDK_HOST_32BIT=1 --&gt; Always use toolchain in 32-bit (see below)
</span><span class='line'>  ndk-build NDK_APPLICATION_MK=&lt;file&gt;
</span><span class='line'>    --&gt; rebuild, using a specific Application.mk pointed to by
</span><span class='line'>        the NDK_APPLICATION_MK command-line variable.
</span><span class='line'>  ndk-build -C &lt;project&gt;     --&gt; build the native code for the project
</span><span class='line'>                                 path located at &lt;project&gt;. Useful if you
</span><span class='line'>                                 don't want to 'cd' to it in your terminal.</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>[6]NDK GDB，Import Module，Prebuilts，Standalone Toolchains以及和CPU相关的三个内容因为我没有涉及过，自己也不是很了解，所以此处暂时搁置了，以后如果用到以后补充。</p></li>
<li><p>[7]<a href="http://blog.csdn.net/smfwuxiao/article/details/6612373">Tips and Tricks 建议和技巧</a></p></li>
</ul>


<h4>那些曾经的头疼的问题</h4>

<ul>
<li>[1]使用Android SDK Manager下载SDK时失败或者很慢</li>
</ul>


<p>在Windows下修改hosts文件：<code>C:\Windows\System32\drivers\etc</code> <br/>
增加如下一行配置：<code>74.125.237.1 dl-ssl.google.com</code></p>

<ul>
<li>[2]<code>Fatal signal 11 (SIGSEGV) at 0x00000004 (code=1), thread 23487 (mple)</code></li>
</ul>


<p>错误原因是因为访问了非法访问的内存地址，具体的原因可能是访问了null对象或者数组，很有可能是Java层传给Native层的对象是null，导致Native层访问了非法访问的地址。<a href="http://stackoverflow.com/questions/14495242/android-fatal-signal-11-sigsegv-at-0x00000040-code-1-error?rq=1">参考网址1</a>   <a href="http://stackoverflow.com/questions/10787676/fatal-signal-11-sigsegv-at-0x00000000-code-1">参考网址2</a></p>

<ul>
<li>[3]使用ADB命令向AVD中复制文件或文件夹时报错</li>
</ul>


<p>默认情况下avd对应的目录是只读的，去掉只读就好了。<a href="http://www.crifan.com/ddms_import_file_error_transfer_error_read_only_file_system/">参考网址</a></p>

<ul>
<li>[4]对android项目执行<code>add Native Support</code>报错</li>
</ul>


<p>使用<code>add Native Support</code>时一定要记住项目不能有jni目录！如果有的话，那就只能先删除(或者备份重要内容)，然后再执行<code>add Native Support</code></p>

<ul>
<li>[5]将String传递到Native层解析出现了乱码！</li>
</ul>


<p>使用自定义的将jstring转换成char*的函数，内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static char* jstringToString(JNIEnv* env, jstring jstr) {
</span><span class='line'>    char* rtn = NULL;
</span><span class='line'>    jclass clsstring = env-&gt;FindClass("java/lang/String");
</span><span class='line'>    jstring strencode = env-&gt;NewStringUTF("utf-8"); //"gbk");//
</span><span class='line'>    jmethodID mid = env-&gt;GetMethodID(clsstring, "getBytes",
</span><span class='line'>            "(Ljava/lang/String;)[B");
</span><span class='line'>    jbyteArray barr = (jbyteArray) env-&gt;CallObjectMethod(jstr, mid, strencode);
</span><span class='line'>    jsize alen = env-&gt;GetArrayLength(barr);
</span><span class='line'>    jbyte* ba = env-&gt;GetByteArrayElements(barr, JNI_FALSE);
</span><span class='line'>    if (alen &gt; 0) {
</span><span class='line'>        rtn = (char*) malloc(alen + 1);
</span><span class='line'>        memcpy(rtn, ba, alen);
</span><span class='line'>        rtn[alen] = '\0';
</span><span class='line'>    }
</span><span class='line'>    env-&gt;ReleaseByteArrayElements(barr, ba, 0);
</span><span class='line'>    return rtn;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>[6]To be continued</li>
</ul>


<p class='post-footer'>
                        Original link:<a href='http://hujiaweibujidao.github.io/blog/2013/11/18/android-ndk-and-opencv-development-2/'>http://hujiaweibujidao.github.io/blog/2013/11/18/android-ndk-and-opencv-development-2/</a><br/>Written by <a href='http://hujiaweibujidao.github.io'>hujiawei</a>&nbsp;Posted at <a href='http://hujiaweibujidao.github.io'>http://hujiaweibujidao.github.io</a><br/>Feel free to read or comment it, and if you want to copy it into your own site, please copy it with its Original Link showed above or you can see the license below for more details.<br />Thanks a lot. Hope you enjoy here! ^_^</p>

</div>


		<footer>
			<p class="meta">
				
  

<span class="byline author vcard">Posted by <span class="fn">hujiawei</span></span>

				








  


<time datetime="2013-11-18T15:59:00+08:00" pubdate data-updated="true">Nov 18<span>th</span>, 2013</time>
				

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/mobiledev/'>mobiledev</a>, <a class='category' href='/blog/categories/opencv/'>opencv</a>
  
</span>


			</p>
			
			<div class="sharing">
  
  
  
</div>

			
			<p class="meta">
				
				<a class="basic-alignment left" href="/blog/2013/11/18/android-ndk-and-opencv-developement/" title="Previous Post: android ndk and opencv developement">&laquo; android ndk and opencv developement</a>
				
				
				<a class="basic-alignment right" href="/blog/2013/11/18/android-ndk-and-opencv-development-3/" title="Next Post: android ndk and opencv development 3">android ndk and opencv development 3 &raquo;</a>
				
			</p>
		</footer>
	</article>
	

	
	<section>
		<h1>Comments</h1>
		<div id="comments" aria-live="polite">
			<!-- Duoshuo Comment BEGIN   data-title=""-->
<div class="ds-thread"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"hujiaweibujidao"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END -->

		</div>
	</section>
	

</div>

<aside class="sidebar">
	
	<section>
  <h1>关于博主</h1><br/>
  <a href="/aboutme/"><img src="/images/me-small.png" width="250px" height="210px" alt="protrait"/></a><br/>
  <p>Hi, I'm Hujiawei, from P.R.China. Now I'm a postgraduate student studying in <a href="http://www.tsinghua.edu.cn/publish/th/index.html">Tsinghua University</a>.
  Wanna know me? <a href="/aboutme/">See here.</a> <br/>	
  </p>
  <a href="http://weibo.com/hujiaweiyinger"><img src="/images/sinaweibo.png" width="40px" height="40px"/></a> &nbsp;
  <a href="https://github.com/hujiaweibujidao"><img src="/images/github.png" width="40px" height="40px"/></a>&nbsp;
  <a href="http://hujiawei.tumblr.com"><img src="/images/tumblr.png" width="40px" height="40px"/></a> &nbsp;
  <a href="https://twitter.com/hujiaweiyinger"><img src="/images/twitter.png" width="40px" height="40px"/></a>
  
  <br/>
  
</section>
<section>
 <h1>分类目录</h1>
 <ul id="categories">
	 <li class='category'><a href='/blog/categories/android/'>android (3)</a></li>
<li class='category'><a href='/blog/categories/mobiledev/'>mobiledev (3)</a></li>
<li class='category'><a href='/blog/categories/octopress/'>octopress (2)</a></li>
<li class='category'><a href='/blog/categories/opencv/'>opencv (3)</a></li>

 </ul>
</section>
<section>
  <h1>近期文章</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/18/android-ndk-and-opencv-development-3/">Android Ndk and Opencv Development 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/android-ndk-and-opencv-development-2/">Android Ndk and Opencv Development 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/android-ndk-and-opencv-developement/">Android Ndk and Opencv Developement</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/make-your-octopress-easy/">Make Your Octopress Easy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/17/hello-octopress/">Hello Octopress</a>
      </li>
    
  </ul>
</section>
<section>
<h1>好友博客</h1>
<ul>
        <li>
        <a href="http://doufunao.github.io/">豆腐脑的幻想乡</a>
        </li>
        <li>
        <a href="http://c4fun.cn/">Code 4 Fun</a>
        </li>
        <li>
        <a href="http://www.tanglei.name/">tanglei的blog</a>
        </li>
        <li>
        <a href="http://www.liaoxuefeng.com/">廖雪峰的官方网站</a>
        </li>
        <li>
        <a href="http://easypi.github.io/">easypi's blog</a>
        </li>
        <li>
        <a href="http://812lcl.github.io/">812lcl的博客</a>
        </li>
        <li>
        <a href="http://wufawei.com/">Ted's Homepage</a>
        </li>
        <li>
        <a href="#">这里会是你吗?</a>
        </li>
</ul>
</section>
	
</aside>



		</div>
	</div>
	
	<footer role="contentinfo">
		<p>
	Copyright &copy; 2013 - hujiawei - <a href="http://happybirthday2yinger.duapp.com/">Happy birthday to MY QUEEN</a> - <span class="credit">Proudly Powered by <a href="http://octopress.org">Octopress</a></span>
	<!-- CNZZ -->
	&nbsp;&nbsp;
	<script type="text/javascript">
		var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
		document.write(unescape("%3Cspan id='cnzz_stat_icon_1000165127'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1000165127%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<!-- license -->
	<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nd/3.0/88x31.png" /></a>
	<br />
	本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh">知识共享署名-禁止演绎 3.0 未本地化版本许可协议</a>进行许可。
</p>
<style>
	.returnTop {
		position: fixed;
		_position: absolute;
		right: 10px;
		bottom: 200px;
		_bottom: auto;
		display: none;
		width: 40px;
		height: 40px;
		border: 1px solid #61b72e;
		border-radius: 4px;
		background: #fff;
		box-shadow: 0 0 5px #F5F5F5;
		text-indent: -9999px;
		cursor: pointer;
	}
	.returnTop .s {
		position: absolute;
		top: -2px;
		_top: -20px;
		left: 10px;
		width: 0;
		height: 0;
		border-width: 10px;
		border-color: transparent transparent #61b72e;
		border-style: dashed dashed solid;
	}
	.returnTop .b {
		position: absolute;
		top: 18px;
		left: 16px;
		height: 12px;
		width: 8px;
		background: #61b72e;
	}
</style>
<div class="returnTop" title="嗖的就上去了！">
	<span class="s"></span>
	<span class="b"></span>
	返回顶部
</div>
<script type="text/javascript">
$(function(){
$(window).bind("scroll", function(){

var scrollTopNum = $(document).scrollTop(),
winHeight = $(window).height(),
returnTop = $("div.returnTop");

(scrollTopNum > 0) ? returnTop.fadeIn("fast") : returnTop.fadeOut("fast");

if (!-[1,]&&!window.XMLHttpRequest) {
returnTop.css("top", scrollTopNum + winHeight - 200);
}

});

$("div.returnTop").click(function() {
$("html, body").animate({ scrollTop: 0 }, 100);
});

});
</script>



	</footer>
	
	











</body>
</html>
