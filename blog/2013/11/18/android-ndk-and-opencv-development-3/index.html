
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Android Ndk and Opencv Development 3 - Hujiawei Bujidao</title>
  <meta name="author" content="hujiawei">

  
  <meta name="description" content="Android NDK 和 OpenCV 整合开发总结(3) 终于写到第三节啦，虽然很累，但是还是要坚持，坚持写完这3篇文章。 这一节的主要内容是OpenCV在Android NDK开发中的应用，包括下面几个方面的内容： 如何实现Static Initialization从而不需要安装OpenCV &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hujiaweibujidao.github.io/blog/2013/11/18/android-ndk-and-opencv-development-3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Hujiawei Bujidao" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


  

</head>

<body   >

	<header role="banner">
		
<hgroup style="text-align: center">
	<h1><a href="/"><img src="/images/conan-paper-small.png"  />Hujiawei Bujidao<img src="/images/conan-hat-small.png"  /></a></h1>
	
	<h2>I will always be your savior! A secret makes a man man!</h2>
	
</hgroup>


	</header>
	<nav role="navigation">
		<ul class="subscription" data-subscription="rss">
  <!--<li><a href="https://github.com/hujiaweibujidao" rel="subscribe-rss" title="subscribe via RSS">View me on GitHub</a></li>-->
  <!--
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
  --> 
</ul>
<!--
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hujiaweibujidao.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form> 
  
-->
<ul class="main-navigation">
  <li><a href="/blog/archives/">Blog</a></li>
  <li><a href="/aboutme/">AboutMe</a></li>
  <li><a href="/math/">Math</a></li>
  <li><a href="/python/">Python</a></li>
  <li><a href="/datamining/">ML-DM-PR</a></li>
  <li><a href="/blog/categories/algorithm/">Algorithms</a></li>
  <li><a href="/blog/categories/mobiledev/">MobileDev</a></li>
  <li><a href="/blog/categories/music/">Music</a></li>
  <li><a href="/blog/categories/picture/">Picture</a></li>
  <!--
  <li><a href="/xjava/">XJava</a></li>
  -->
  <!-- <li><a href="/datamining/">Projects</a></li> -->
</ul>


	</nav>
	<div id="main">
		<div id="content">
			<div>

<article class="hentry" role="article">
		
  <header>
    
      <h1 class="entry-title">Android Ndk and Opencv Development 3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-18T21:35:00+08:00" pubdate data-updated="true">Nov 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3 id="android-ndk--opencv-3">Android NDK 和 OpenCV 整合开发总结(3)</h3>

<p>终于写到第三节啦，虽然很累，但是还是要坚持，坚持写完这3篇文章。</p>

<p>这一节的主要内容是OpenCV在Android NDK开发中的应用，包括下面几个方面的内容：</p>

<ul>
  <li>如何实现Static Initialization从而不需要安装OpenCV Manager运行含OpenCV library的app</li>
  <li>对十份论文和报告中的关于OpenCV和Android NDK开发的总结</li>
  <li>如何使用Android中的摄像头，常见的问题有哪些? </li>
  <li>OpenCV 和 Android NDK 整合开发的一般途径</li>
</ul>

<h4 id="static-initialization">1.实现Static Initialization</h4>

<p>实现Static Initialization就是指将OpenCV Library添加到app package中，不需要安装OpenCV Manager这个app就能运行，<a href="http://docs.OpenCV.org/trunk/doc/tutorials/introduction/Android_binary_package/dev_with_OCV_on_Android.html">官方文档有介绍</a>，但是不详细，尤其是最后那句代码到底要放在什么地方很多人都不清楚，其实并不需要像官方文档中介绍的那样配置，我想在这里介绍下如何修改FaceDetection项目的源码来做到这点。(最好是找一个包含jni代码的项目进行修改)</p>

<ul>
  <li>[1]打开jni下的Android.mk文件，修改OpenCV的那一部分，将<code>off</code>设置为<code>on</code>，并设置<code>OpenCV_LIB_TYPE</code>为<code>SHARED</code>，结果如下：  </li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">OpenCV_CAMERA_MODULES:=on
</span><span class="line">OpenCV_INSTALL_MODULES:=on
</span><span class="line">OpenCV_LIB_TYPE:=SHARED
</span><span class="line">include ${OpenCVROOT}/sdk/native/jni/OpenCV.mk</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>[2]打开FdActivity.java文件，在其中添加一个静态初始化块代码，它是用来加载<code>OpenCV_java</code>库的，由于FaceDetection中还用了另一个库detection_based_tracker(用于人脸跟踪)，所以要在<code>else</code>子句中加载进来：</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class=""><span class="line">static {
</span><span class="line">	Log.i(TAG, "OpenCV library load!");
</span><span class="line">	if (!OpenCVLoader.initDebug()) {
</span><span class="line">		Log.i(TAG, "OpenCV load not successfully");
</span><span class="line">	} else {
</span><span class="line">		System.loadLibrary("detection_based_tracker");// load other libraries
</span><span class="line">	}
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>[3]删除FdActivity.java的OnResume()方法的最后那句，不让它去访问OpenCV Manager。</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class=""><span class="line">@Override
</span><span class="line">public void onResume() {
</span><span class="line">	super.onResume();
</span><span class="line">//OpenCVLoader.initAsync(OpenCVLoader.OpenCV_VERSION_2_4_3, this, mLoaderCallback);//
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>[4]修改FdActivity.java的OnCreate()方法，从上面的<code>private BaseLoaderCallback mLoaderCallback = new BaseLoaderCallback(this)</code>代码块中拷贝<code>try-catch</code>块放到OnCreate的<code>setContentView()</code>之后，然后拷贝<code>mOpenCVCameraView.enableView();</code>放到<code>mOpenCVCameraView = (CameraBridgeViewBase) findViewById(R.id.fd_activity_surface_view);</code>之后，修改后的OnCreate()方法如下：</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
</pre></td><td class="code"><pre><code class=""><span class="line">public void onCreate(Bundle savedInstanceState) {
</span><span class="line">	Log.i(TAG, "called onCreate");
</span><span class="line">	super.onCreate(savedInstanceState);
</span><span class="line">	getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
</span><span class="line">
</span><span class="line">	setContentView(R.layout.face_detect_surface_view);
</span><span class="line">
</span><span class="line">	//
</span><span class="line">	try {
</span><span class="line">		// load cascade file from application resources
</span><span class="line">		InputStream is = getResources().openRawResource(R.raw.lbpcascade_frontalface);
</span><span class="line">		File cascadeDir = getDir("cascade", Context.MODE_PRIVATE);
</span><span class="line">		mCascadeFile = new File(cascadeDir, "lbpcascade_frontalface.xml");
</span><span class="line">		FileOutputStream os = new FileOutputStream(mCascadeFile);
</span><span class="line">
</span><span class="line">		byte[] buffer = new byte[4096];
</span><span class="line">		int bytesRead;
</span><span class="line">		while ((bytesRead = is.read(buffer)) != -1) {
</span><span class="line">			os.write(buffer, 0, bytesRead);
</span><span class="line">		}
</span><span class="line">		is.close();
</span><span class="line">		os.close();
</span><span class="line">
</span><span class="line">		mJavaDetector = new CascadeClassifier(mCascadeFile.getAbsolutePath());
</span><span class="line">		if (mJavaDetector.empty()) {
</span><span class="line">			Log.e(TAG, "Failed to load cascade classifier");
</span><span class="line">			mJavaDetector = null;
</span><span class="line">		} else
</span><span class="line">			Log.i(TAG, "Loaded cascade classifier from " + mCascadeFile.getAbsolutePath());
</span><span class="line">
</span><span class="line">		mNativeDetector = new DetectionBasedTracker(mCascadeFile.getAbsolutePath(), 0);// hujiawei
</span><span class="line">
</span><span class="line">		cascadeDir.delete();
</span><span class="line">
</span><span class="line">	} catch (IOException e) {
</span><span class="line">		e.printStackTrace();
</span><span class="line">		Log.e(TAG, "Failed to load cascade. Exception thrown: " + e);
</span><span class="line">	}
</span><span class="line">
</span><span class="line">	//
</span><span class="line">
</span><span class="line">	mOpenCVCameraView = (CameraBridgeViewBase) findViewById(R.id.fd_activity_surface_view);
</span><span class="line">	mOpenCVCameraView.enableView();//
</span><span class="line">	mOpenCVCameraView.setCvCameraViewListener(this);
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>[5]OK，卸载安装好的OpenCV Manager，然后重新调试运行FaceDetection试试，它已经可以自行运行了！  </li>
</ul>

<h4 id="opencvandroid-ndk">2.对十份论文和报告中的关于OpenCV和Android NDK开发的总结</h4>

<p>这10篇文献大部分[<a href="http://pan.baidu.com/s/19WOVq">百度网盘下载地址</a>]都还是停留如何在Android开发中使用OpenCV library，没有牵涉到具体的实现领域。具体总结如下：</p>

<ul>
  <li>_利用OpenCV实现在Android系统下的人脸检测</li>
</ul>

<p>本文主要介绍了如何在底层通过OpenCV来对人脸部分进行检测，得到的人脸位置数据通过JNI传递给Java层，详细介绍了其中的JNI代码和共享库的构建过程，对图片是通过图片的路径来进行传递的，因为这里的检测只是对单张静态的图片进行检测。</p>

<ul>
  <li>_Tutorial-2-OpenCV-for-Android-Setup-Macintosh-API11</li>
</ul>

<p>本文主要是介绍了OpenCV和Android NDK开发环境的搭建，以及基于示例程序Face-Detection的演示。使用的方式是将OpenCV Library Project作为库，然后调用OpenCV Android API。</p>

<ul>
  <li>_Android application for Face Recognition</li>
</ul>

<p>这是一份详细的项目介绍，实现了几种基于Android平台的人脸检测和识别，包括Google API和OpenCV的，但是OpenCV的由于需要Library Project，而且算法过于复杂，作者便自行开发了人脸检测库，有6大特性，其中包括了眼镜和嘴巴的检测。</p>

<ul>
  <li>_ECCV-2012-OpenCV4Android</li>
</ul>

<p>这份报告写得精简但是内容丰富，有几个重要点：<br />
(1) 使用OpenCV的Android应用开发方式，对应不同的开发人群：Java developer / Native developer <br />
(2) OpenCV4Android目前的局限性，以及开发过程中对于提高性能和开发效率需要注意的事项</p>

<ul>
  <li>_Introduction to OpenCV for Android devices</li>
</ul>

<p>本文设计的内容都很基础，涉及到OpenCV和Android开发的环境搭建，亮点是最后的Using C++ OpenCV code，这里是在Android ndk中使用OpenCV本地代码的重要配置项。</p>

<ul>
  <li>_OpenCV-facedetection</li>
</ul>

<p>这份报告讲述了很多OpenCV的相关知识，另外还详细讲述了一个人脸检测的算法</p>

<ul>
  <li>_OpenCV on Android Platforms</li>
</ul>

<p>这份报告内容也比较多，但是都很基础。</p>

<ul>
  <li><em>BDTI_ARMTechCon</em>2012_OpenCV_Android</li>
</ul>

<p>这份报告讲的是OpenCV在嵌入式设备中的应用，其中介绍了OpenCV在Android上的开发，需要注意的是OpenCV2.4开始提供了native Android camera support！</p>

<ul>
  <li>_OpenCV Based Real-Time Video Processing  Using Android Smartphone</li>
</ul>

<p>这篇论文介绍了利用OpenCV对实时的视频进行处理和纯Android library进行处理的比较，发现利用OpenCV处理的结果更加准确，效率更快，而且更加省电。比较时使用的都是基本图像处理操作，例如灰度化，高斯模糊，Sobel边缘检测等等。</p>

<ul>
  <li>_Realtime Computer Vision  with OpenCV</li>
</ul>

<p>这篇文章比较有意思，大致看了下，介绍了OpenCV在移动终端的应用。</p>

<h4 id="android">3.Android的摄像头</h4>

<ul>
  <li>
    <p>关于如何使用Android的摄像头：Android设备一般有两个摄像头，前置摄像头和后置摄像头，在进行和摄像头相关的应用开发的时候很容易遇到各种问题，推荐以下几篇文章：<br />
<a href="https://developer.Android.com/guide/topics/media/camera.html">Android Developer中有对应的文档:Camera</a><br />
<a href="http://blog.csdn.net/yinyuan1987/article/details/6969225">这位作者的总结：Android相机</a><br />
<a href="http://stackoverflow.com/questions/2779002/how-to-open-front-camera-on-Android-platform">StackOverflow上关于如何调用前置摄像头</a><br />
<a href="http://blog.csdn.net/yangzl2008/article/details/9262505">如何在Android中后台开启摄像头默默拍照</a><br />
<a href="http://blog.csdn.net/ocean20/article/details/8772196">关于Camera的三种Callback</a></p>
  </li>
  <li>
    <p>关于保存预览图片：Android中的<code>BitmapFactory.decodeByteArray</code>只支持一定的格式，Camara默认的previewformat格式为<code>NV21</code>(对于大多数的Android设备，即使修改CameraParameters的设置也还是不行)，所以在获得bitmap时，需要进行转换，通过YuvImage类来转换成JPEG格式，然后再保存到文件中。<br />
<a href="http://www.cnblogs.com/liuan/archive/2012/01/10/2318300.html">Google Group上的讨论</a>  </p>
  </li>
  <li>
    <p>关于如何在预览界面上添加一个矩形框，类似二维码扫描那样，原理很简单，一个使用SurfaceView，另一个使用ImageVIew(或者SurfaceView也行)，推荐文章：<br />
<a href="http://blog.csdn.net/yanzi1225627/article/details/8580034">Android摄像头中预览界面添加矩形框</a></p>
  </li>
  <li>
    <p>关于如何进行和OpenCV有关的摄像头开发：有了OpenCV的library之后，关于摄像头的开发可谓是简单了很多，可以参见OpenCV for Android中的三个Tutorial(CameraPreview, MixingProcessing和CameraControl)，源码都在OpenCV-Android sdk的samples目录下，这里简单介绍下： <br />
OpenCV Library中提供了两种摄像头，一种是Java摄像头-<code>org.OpenCV.Android.JavaCameraView</code>，另一种是Native摄像头-<code>org.OpenCV.Android.NativeCameraView</code> (可以运行CameraPreview这个项目来体验下两者的不同，其实差不多)。两者都继承自<code>CameraBridgeViewBase</code>这个抽象类，但是JavaCamera使用的就是Android SDK中的<code>Camera</code>，而NativeCamera使用的是OpenCV中的<code>VideoCapture</code>。    </p>
  </li>
  <li>
    <p>关于OpenCV的Camera在Layout文件中的配置：<code>OpenCV:show_fps</code>在layout中如果设置为<code>true</code>的话显示界面中会出现当前摄像头帧率的信息以及图片的大小，<code>OpenCV:camera_id</code>的配置有三种<code>front</code>,<code>back</code>,<code>any</code>分别对应前置摄像头，后置摄像头和默认的摄像头(其实也就是后置摄像头)。  </p>
  </li>
  <li>
    <p>关于<code>CvCameraViewListener2</code>接口：它可以方便的处理和摄像头的交互，该接口只有三个函数，分别在Camera打开(<code>onCameraViewStarted</code>)，关闭(<code>onCameraViewStopped</code>)和预览的图片帧到了的时候(<code>onCameraFrame</code>)调用。其中<code>OnCameraFrame</code>这个方法很重要，如果要对图片进行处理的话一般都是在这里面处理的，这个函数的输入参数是<code>CvCameraViewFrame</code>，需要注意的是，不要在这个方法的外面使用这个变量，因为这个对象没有它自己的状态，在回调方法的外面它的行为是不可预测的！它提供了两个有用的方法<code>rgba()</code>和<code>gray()</code>分别得到图像帧的RGBA格式和灰度图，<code>OnCameraFrame</code>的返回值是<strong>RGBA格式</strong>的图像，这个很重要！一定要保证处理了之后的图像是RGBA格式的Android系统才能正常显示！<a href="http://docs.OpenCV.org/trunk/doc/tutorials/introduction/Android_binary_package/dev_with_OCV_on_Android.html">来自OpenCV文档:Android Development with Android</a>     </p>
  </li>
</ul>

<p><code>Note Do not save or use CvCameraViewFrame object out of onCameraFrame callback. This object does not have its own state and its behavior out of callback is unpredictable!</code>  </p>

<ul>
  <li>关于如何传递摄像头预览的图像数据给Native代码：这个很重要！我曾经试过很多的方式，大致思路有：   </li>
</ul>

<p>①传递图片路径：这是最差的方式，我使用过，速度很慢，主要用于前期开发的时候进行测试，测试Java层和Native层的互调是否正常。   </p>

<p>②传递预览图像的字节数组到Native层，然后将字节数组处理成RGB或者RGBA的格式[具体哪种格式要看你的图像处理函数能否处理RGBA格式的，如果可以的话推荐转换成RGBA格式，因为返回的也是RGBA格式的。网上有很多的文章讨论如何转换：一种方式是使用一个自定义的函数进行编码转换(可以搜索到这个函数)，另一个种方式是使用OpenCV中的Mat和cvtColor函数进行转换，接着调用图像处理函数，处理完成之后，将处理的结果保存在一个整形数组中(实际上就是RGB或者RGBA格式的图像数据)，最后调用Bitmap的方法将其转换成bitmap返回。这种方法速度也比较慢，但是比第一种方案要快了不少，具体实现过程可以看下面的推荐书籍。   </p>

<p>③使用OpenCV的摄像头：JavaCamera或者NativeCamera都行，好处是它进行了很多的封装，可以直接将预览图像的Mat结构传递给Native层，这种传递是使用Mat的内存地址(long型)，Native层只要根据这个地址将其封装成Mat就可以进行处理了，另外，它的回调函数的返回值也是Mat，非常方便！这种方式速度较快。详细过程可以查看OpenCV-Android sdk的samples项目中的Tutorial2-MixedProcessing。 </p>

<ul>
  <li>关于摄像头预览界面倒置的问题：很多时候(一般是将应用设置为<code>portrait</code>模式之后)在调用了OpenCV的Camera之后，出现预览内容倒置了90度的现象，原因是OpenCV的Camera默认情况下是以<code>landscape</code>模式运行的，一个可行但是不是很好的解决方案是修改OpenCV库中的<code>org.opencv.camera.CameraBridgeViewBase</code>类中的<code>deliverandDraw</code>方法，<a href="http://stackoverflow.com/questions/19190921/always-open-in-landscape-mode-orientation-for-front-camera-in-opencv-javacv">问题参考链接</a></li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
</pre></td><td class="code"><pre><code class=""><span class="line">protected void deliverAndDrawFrame(CvCameraViewFrame frame) {
</span><span class="line">        Mat modified;
</span><span class="line">
</span><span class="line">        if (mListener != null) {
</span><span class="line">            modified = mListener.onCameraFrame(frame);
</span><span class="line">        } else {
</span><span class="line">            modified = frame.rgba();
</span><span class="line">        }
</span><span class="line">
</span><span class="line">        boolean bmpValid = true;
</span><span class="line">        if (modified != null) {
</span><span class="line">            try {
</span><span class="line">                Utils.matToBitmap(modified, mCacheBitmap);
</span><span class="line">            } catch(Exception e) {
</span><span class="line">                Log.e(TAG, "Mat type: " + modified);
</span><span class="line">                Log.e(TAG, "Bitmap type: " + mCacheBitmap.getWidth() + "*" + mCacheBitmap.getHeight());
</span><span class="line">                Log.e(TAG, "Utils.matToBitmap() throws an exception: " + e.getMessage());
</span><span class="line">                bmpValid = false;
</span><span class="line">            }
</span><span class="line">        }
</span><span class="line">
</span><span class="line">        if (bmpValid &amp;&amp; mCacheBitmap != null) {
</span><span class="line">            Canvas canvas = getHolder().lockCanvas();
</span><span class="line">            if (canvas != null) {
</span><span class="line">//                canvas.drawColor(0, android.graphics.PorterDuff.Mode.CLEAR);
</span><span class="line">//                Log.d(TAG, "mStretch value: " + mScale);
</span><span class="line">//
</span><span class="line">//                if (mScale != 0) {
</span><span class="line">//                    canvas.drawBitmap(mCacheBitmap, new Rect(0,0,mCacheBitmap.getWidth(), mCacheBitmap.getHeight()),
</span><span class="line">//                         new Rect((int)((canvas.getWidth() - mScale*mCacheBitmap.getWidth()) / 2),
</span><span class="line">//                         (int)((canvas.getHeight() - mScale*mCacheBitmap.getHeight()) / 2),
</span><span class="line">//                         (int)((canvas.getWidth() - mScale*mCacheBitmap.getWidth()) / 2 + mScale*mCacheBitmap.getWidth()),
</span><span class="line">//                         (int)((canvas.getHeight() - mScale*mCacheBitmap.getHeight()) / 2 + mScale*mCacheBitmap.getHeight())), null);
</span><span class="line">//                } else {
</span><span class="line">//                     canvas.drawBitmap(mCacheBitmap, new Rect(0,0,mCacheBitmap.getWidth(), mCacheBitmap.getHeight()),
</span><span class="line">//                         new Rect((canvas.getWidth() - mCacheBitmap.getWidth()) / 2,
</span><span class="line">//                         (canvas.getHeight() - mCacheBitmap.getHeight()) / 2,
</span><span class="line">//                         (canvas.getWidth() - mCacheBitmap.getWidth()) / 2 + mCacheBitmap.getWidth(),
</span><span class="line">//                         (canvas.getHeight() - mCacheBitmap.getHeight()) / 2 + mCacheBitmap.getHeight()), null);
</span><span class="line">//                }
</span><span class="line">
</span><span class="line">                //ABC : Fixed for image rotation
</span><span class="line">                //TODO Why portrait is not opening in fulls creen
</span><span class="line">                Matrix matrix = new Matrix();
</span><span class="line">                int height_Canvas = canvas.getHeight();
</span><span class="line">                int width_Canvas = canvas.getWidth();
</span><span class="line">
</span><span class="line">                int width = mCacheBitmap.getWidth();
</span><span class="line">                int height = mCacheBitmap.getHeight();
</span><span class="line">
</span><span class="line">                float f1 = (width_Canvas - width) / 2;
</span><span class="line">                float f2 = (height_Canvas - height) / 2;
</span><span class="line">                matrix.preTranslate(f1, f2);
</span><span class="line">                if(getResources().getConfiguration().orientation == Configuration.ORIENTATION_PORTRAIT)
</span><span class="line">                matrix.postRotate(270f,(width_Canvas) / 2,(height_Canvas) / 2);
</span><span class="line">                canvas.drawBitmap(mCacheBitmap, matrix, new Paint());
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line">                if (mFpsMeter != null) {
</span><span class="line">                    mFpsMeter.measure();
</span><span class="line">                    mFpsMeter.draw(canvas, 20, 30);
</span><span class="line">                }
</span><span class="line">                getHolder().unlockCanvasAndPost(canvas);
</span><span class="line">            }
</span><span class="line">        }
</span><span class="line">    }</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="opencv--opencv-ndk-">3.OpenCV 和 OpenCV NDK 整合开发的一般途径</h4>

<p>在进行这类开发的时候，需要考虑如何在Android中使用OpenCV，并且如果需要调用摄像头的话，要考虑以下内容：<br />
首先，是否是在原有的C/C++代码上进行移植，如果是的话，那么尽量考虑使用ndk开发，否则使用OpenCV for Android编写Java代码进行开发，效率不会比native代码低多少； <br />
其次，如果是需要OpenCV library，是否能够容忍运行应用还需要安装OpenCV Manager，如果不能的话，则在开发时要考虑将OpenCV binaries添加到应用中进行static initialization，但其实使用OpenCV Manager是有很多好处的，上面的论文和OpenCV官网都有相应的文档介绍它的好处和使用方式； <br />
接着，是否需要调用摄像头，如果需要的话，是使用原生Android的Camera还是使用OpenCV的Camera，如果是OpenCV Camera的话，是使用Java调用摄像头还是Native调用摄像头；<br />
最后，图片如何进行传递，如果是单张静态图片进行处理的话，只需要路径就行了，但是如果是在视频状态下对图片进行处理的话，那么就只能传递图像数据了，这里涉及到了Android中如何获取预览的图像数据以及如何将其传递到底层，又如何进行转换(一般是YUV转成RGB)使得OpenCV可以进行处理，处理完了之后，又如何将处理得到的图片传递给Java层。</p>

<p>推荐一本书籍《Mastering OpenCV with Practical Computer Vision Projects》，电子书可以在<a href="http://www.ppurl.com/2012/12/mastering-OpenCV-with-practical-computer-vision-projects.html">皮皮书屋</a>下载，<a href="https://github.com/MasteringOpenCV">原书源码在Github上</a>。该书第一章介绍如何开发一个使用OpenCV的Android项目-<code>Cartoonifer and Skin Changer for Android</code>，这个项目涉及到了OpenCV在Android中的方方面面，采用的是第二种图像数据传递方式，其中他提出了很多可以优化的地方，包括： <br />
①尽量使用Mat而不要使用IplImage <br />
②尽量保证你的图像处理函数能够处理RGBA格式的图像  <br />
③如果可以先压缩图像大小再对图像进行处理  <br />
④使用noise filter降低图像中的噪声。    </p>

<p>总之，极力推荐此书，我以后的文章中还会提到这本书，嘿嘿。</p>

<p>OK！脑子有点乱了，这节逻辑不太严谨，嘿嘿，但总算完结了！多谢关注！</p>

<p class="post-footer">
                        Original link:<a href="http://hujiaweibujidao.github.io/blog/2013/11/18/android-ndk-and-opencv-development-3/">http://hujiaweibujidao.github.io/blog/2013/11/18/android-ndk-and-opencv-development-3/</a><br />Written by <a href="http://hujiaweibujidao.github.io">hujiawei</a>&nbsp;Posted at <a href="http://hujiaweibujidao.github.io">http://hujiaweibujidao.github.io</a><br />Feel free to read or comment it, and if you want to copy it into your own site, please copy it with its Original Link showed above or you can see the license below for more details.If you have any problem or suggestion, please comment below. :-)<br />Thanks a lot. Hope you enjoy here! :-)</p>
</div>


		<footer>
			<p class="meta">
				
  

<span class="byline author vcard">Posted by <span class="fn">hujiawei</span></span>

				








  


<time datetime="2013-11-18T21:35:00+08:00" pubdate data-updated="true">Nov 18<span>th</span>, 2013</time>
				

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/mobiledev/'>mobiledev</a>, <a class='category' href='/blog/categories/opencv/'>opencv</a>
  
</span>


			</p>
			
			<div class="sharing">
  
  
  
</div>

			
			<p class="meta">
				
				<a class="basic-alignment left" href="/blog/2013/11/18/android-ndk-and-opencv-development-2/" title="Previous Post: Android Ndk and Opencv Development 2">&laquo; Android Ndk and Opencv Development 2</a>
				
				
				<a class="basic-alignment right" href="/blog/2014/02/21/android-ndk-and-opencv-development-4/" title="Next Post: Android Ndk and Opencv Development 4">Android Ndk and Opencv Development 4 &raquo;</a>
				
			</p>
		</footer>
	</article>
	

	
	<section>
		<h1>Comments</h1>
		<div id="comments" aria-live="polite">
			<!-- Duoshuo Comment BEGIN   data-title=""-->
<div class="ds-thread"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"hujiaweibujidao"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END -->

		</div>
	</section>
	
</div>

<aside class="sidebar">
  
	<section>
	<h1>关于博主</h1><br/>
  <a href="/aboutme/"><img src="/images/me-small.png" width="250px" height="210px" alt="protrait"/></a><br/>
  <p>Hi, I'm Hujiawei, from P.R.China. Now I'm a postgraduate student studying in <a href="http://www.tsinghua.edu.cn/publish/th/index.html">Tsinghua University</a>.
  Wanna know me? <a href="/aboutme/">See here.</a> 
  </p>
  
  <img src="/images/conan-mainperson.png" width="250px" height="210px" alt="conan"/>
  
  <br/>
  
    <a href="http://weibo.com/hujiaweiyinger"><img src="/images/sinaweibo.png" width="40px" height="40px"/></a> &nbsp;
  <a href="https://github.com/hujiaweibujidao"><img src="/images/github.png" width="40px" height="40px"/></a>&nbsp;
  <a href="http://hujiawei.tumblr.com"><img src="/images/tumblr.png" width="40px" height="40px"/></a> &nbsp;
  <a href="https://twitter.com/hujiaweiyinger"><img src="/images/twitter.png" width="40px" height="40px"/></a>&nbsp;
  <a href="http://www.douban.com/people/60272837/"><img src="/images/douban.png" width="40px" height="40px"/></a>
 
 <br/>
    
    <!--autoplay="autoplay" -->
    <!--
<audio width="200" height="32" 
style="margin: auto; top: 0; right: 0; bottom: 0; left: 0;" 
controls="controls" 
name="media" 
src="http://hujiaweibujidao.github.io/music/Wouldnt-It-Be-Nice.mp3">
</audio>
-->
  
  
  <!--baidu-->
  <!--
  <div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>  
-->

</section>
<section>
 <h1>分类目录</h1>
 <ul id="categories">
	 <li class='category'><a href='/blog/categories/algorithm/'>algorithm (11)</a></li>
<li class='category'><a href='/blog/categories/android/'>android (5)</a></li>
<li class='category'><a href='/blog/categories/hadoop/'>hadoop (1)</a></li>
<li class='category'><a href='/blog/categories/ios/'>ios (1)</a></li>
<li class='category'><a href='/blog/categories/mac/'>mac (2)</a></li>
<li class='category'><a href='/blog/categories/machinelearning/'>machinelearning (1)</a></li>
<li class='category'><a href='/blog/categories/math/'>math (23)</a></li>
<li class='category'><a href='/blog/categories/matlab/'>matlab (1)</a></li>
<li class='category'><a href='/blog/categories/mobiledev/'>mobiledev (5)</a></li>
<li class='category'><a href='/blog/categories/music/'>music (2)</a></li>
<li class='category'><a href='/blog/categories/octopress/'>octopress (4)</a></li>
<li class='category'><a href='/blog/categories/opencv/'>opencv (5)</a></li>
<li class='category'><a href='/blog/categories/picture/'>picture (2)</a></li>
<li class='category'><a href='/blog/categories/python/'>python (2)</a></li>

 </ul>
</section>
<section>
  <h1>近期文章</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/20/csu-beautiful-scenery/">CSU Beautiful Scenery</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/19/statistics-summary-4/">SS 4-Hypothesis Testing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/19/statistics-summary-2-1/">SS 3-Continuous Distribution</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/19/statistics-summary-2/">SS 3-Discrete Distribution</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/19/statistics-summary-3/">SS 2-Descriptive Statistics</a>
      </li>
    
  </ul>
</section>
<section>
	<h1>好友博客</h1>
	<ul>
		<li>
			<a href="http://doufunao.github.io/">豆腐脑的幻想乡</a>
		</li>
		<li>
			<a href="http://c4fun.cn/">Code 4 Fun</a>
		</li>
		<li>
			<a href="http://www.tanglei.name/">TangLei blog</a>
		</li>
		<li>
			<a href="http://ontheroad.sinaapp.com/">Tian Jun-Find My Way</a>
		</li>
		
		<li>
			<a href="http://www.liaoxuefeng.com/">廖雪峰的官方网站</a>
		</li>
		<li>
			<a href="http://beader.me/">Beader</a>
		</li>
		<li>
			<a href="http://blog.csdn.net/v_JULY_v">结构之法，算法之道</a>
		</li>
				<li>
			<a href="http://www.renfei.org/blog/">Renfei Song</a>
		</li>
		<li>
			<a href="http://bluedavy.me">BlueDavy之技术blog</a>
		</li>
		<li>
			<a href="http://blog.jobbole.com/category/python/">伯乐在线-Python</a>
		</li>
		<li>
			<a href="http://www.douban.com/group/python/">豆瓣小组-Python</a>
		</li>
		<li>
			<a href="#">这里会是你吗?</a>
		</li>
	</ul>
</section>
	
</aside>


		</div>
	</div>
	
	<footer role="contentinfo">
		<p>
  	Copyright &copy; 2014 - hujiawei - <a href="http://hujiaweibujidao.github.io/happybirthday/">Happy birthday to MY QUEEN</a> - <span class="credit">Proudly Powered by <a href="http://octopress.org">Octopress</a></span>
  	
<!-- mathjax config similar to math.stackexchange  -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

<!-- the following line is incorrect! -->
<!--
<script type="text/javascript" src="https://stackedit.io/libs/MathJax/MathJax.js?config=TeX-AMS_HTML"></script>
-->

<!--baidu-->
<!--
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"1","bdPos":"left","bdTop":"250"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
-->

	<!-- CNZZ -->
	&nbsp;&nbsp;
	<script type="text/javascript">
		var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
		document.write(unescape("%3Cspan id='cnzz_stat_icon_1000165127'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1000165127%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
	</script>
	
	<!--baidu share-->
	<!--
	<div class="bdsharebuttonbox" style="display: inline;"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
	-->
	<!-- license -->
	<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nd/3.0/88x31.png" /></a>
	本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh">知识共享署名-禁止演绎 3.0 未本地化版本许可协议</a>进行许可。

</p>

<!--hujiawei custom blockquote-->
<!--for block quote
<style>
blockquote{
	font:inherit;
	font-size:60%;
	font-style:normal;
	line-height:1.0em;
	color:rgba(0,0,0,0.5);
}
</style>-->

<!-- gutter for code line-numbers!! -->
<!--for block quote-->
<!--
<style>
blockquote{
	font:inherit;
	font-size:60%;
	font-style:normal;
	line-height:1.0em;
	color:rgba(0,0,0,0.5);
}

.gutter{
	display: none;
}

.highlight, .gist-highlight {
margin-bottom: 1.8em;
background: #002b36;
overflow-y: hidden;
overflow-x: auto;
}
</style>
-->

<!--return to top-->
<style>
	.returnTop {
		position: fixed;
		_position: absolute;
		right: 10px;
		bottom: 200px;
		_bottom: auto;
		display: none;
		width: 40px;
		height: 40px;
		border: 1px solid #61b72e;
		border-radius: 4px;
		background: #fff;
		box-shadow: 0 0 5px #F5F5F5;
		text-indent: -9999px;
		cursor: pointer;
	}
	.returnTop .s {
		position: absolute;
		top: -2px;
		_top: -20px;
		left: 10px;
		width: 0;
		height: 0;
		border-width: 10px;
		border-color: transparent transparent #61b72e;
		border-style: dashed dashed solid;
	}
	.returnTop .b {
		position: absolute;
		top: 18px;
		left: 16px;
		height: 12px;
		width: 8px;
		background: #61b72e;
	}
</style>
<div class="returnTop" title="嗖的就上去了！">
	<span class="s"></span>
	<span class="b"></span>
	返回顶部
</div>
<script type="text/javascript">
$(function(){
$(window).bind("scroll", function(){

var scrollTopNum = $(document).scrollTop(),
winHeight = $(window).height(),
returnTop = $("div.returnTop");

(scrollTopNum > 0) ? returnTop.fadeIn("fast") : returnTop.fadeOut("fast");

if (!-[1,]&&!window.XMLHttpRequest) {
returnTop.css("top", scrollTopNum + winHeight - 200);
}

});

$("div.returnTop").click(function() {
$("html, body").animate({ scrollTop: 0 }, 100);
});

});
</script>

	</footer>
	
	













</body>
</html>
